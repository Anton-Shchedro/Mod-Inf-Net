## Usage 

This project is made in the form of several scripts, and in order to use different parts of this project, you need to run the scripts separately.

# Environment (Prerequisites)

Inf-Net use environments with CUDA-10.0. It may work with other environment, but is not guarantee.

Creating a virtual environment in terminal: conda create -n INFnet python=3.6.

Installing necessary packages: pip install -r requirements.txt.

Installing THOP for counting the FLOPs/Params of model (of necessity).

Some required packages may fail during installation, in which case the user have to find a workaround to install the missing packages.

# Training Inf-Net

Different backbones can be used to train Inf-Net, but only Res2Net was used in this project, and the correct operation of other backbones is not guaranteed.

To train Inf-Net use MyTrain_LungInf.py with the following parameters:

- --train_path is path to training dataset. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.
- --is_semi for Inf-Net has to be set to False.
- --is_pseudo for Inf-Net has to be set to False.

Following parameters are optional to change:

- --backbone change different backbone. Possible choice: VGGNet16, ResNet50, Res2Net50. By default is Res2Net50
- --epoch by default is 100. Is epoch number.
- --batchsize is training batch size. Depends of users hardware. By default is 24.
- --num_workers is number of workers in dataloader. Depends of users hardware. By default is 8
- --trainsize is set the size of training sample. This parameter specify the height and width of image in pixels. By default is 352.
- --is_thop - whether calculate FLOPs/Params (Thop). By default is False.
- --net_channel is internal channel numbers in the Inf-Net. By default is 32.
- --n_classes is number of classes to segment. Binary segmentation when 1. By default is 1
- ...
- -h for the full list of parameters


The weights will be saved in ./Snapshots/save\_weights/Inf-Net/

\subsection{Training of Semi-Inf-Net}

Semi-inf-Net, as was mention before, use Inf-Net as initial network for generation of pseudo labels. Is necessary to train Inf-Net before Semi-Inf-Net.

First divide the dataset of unlabeled images in groups of 5 images. It's possible to use ./Code/utils/split\_1600.py to do it with following parameters:

\begin{itemize}
    \item --data\_path is path to unlabeled images.
    \item --save\_path is path to save groups of images.
\end{itemize}

Then run PseudoGenerator.py with folowing parameters:

\begin{itemize}
    \item --data\_path is path unlabeled images (--save\_path from split\_1600.py).
    \item --label\_path is path to labeled images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.
\end{itemize}

Additional parameters are optional:

\begin{itemize}
    \item --epoch by default is 100. Is epoch number.
    \item --batchsize is training batch size. Depends of users hardware. By default is 24.
    \item --trainsize is set the size of training sample. This parameter specify the height and width of image in pixels. By default is 352.
    \item ...
    \item -h for the full list of parameters
\end{itemize}

The pseudo dataset will be in folder "Pseudo" in data\_path directory.

When unlabeled images have pseudo labels, run {MyTrain\_LungInf.py} \cite{Inf-Net} with the following parameters:

\begin{itemize}
    \item --train\_path is path to dataset with pseudo labeled images (generated by PseudoGenerator.py)
    \item --is\_semi set to False.
    \item --is\_pseudo set to True.
\end{itemize}

Then run again {MyTrain\_LungInf.py} \cite{Inf-Net} with the following parameters:

\begin{itemize}
    \item --train\_path is path to \textbf{labeled} images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.
    \item --is\_semi set to True.
    \item --is\_pseudo set to False.
\end{itemize}

The weights will be saved in ./Snapshots/save\_weights/Semi-Inf-Net

\subsection{Creation of resulting images}

To generate a GT image (Inf-Net or Semi-Inf-Net) from a test image without threshold, run MyTest\_LungInf.py \cite{Inf-Net}. To generate a GT image (Inf-Net or Semi-Inf-Net) from a test image with threshold, run MyTBin.py

Following parameters are in both scripts:

\begin{itemize}
    \item --data\_path is path to test dataset.  This folder should contain an "Imgs" folder with images.
    \item --pth\_path is path to weights of network.
    \item --save\_path is path where results will be saved. (To save in a folder named "Folder", the path must end with "Folder/", otherwise all files will be saved in the previous folder and with the image name prefixed "Folder".)
\end{itemize}

Following parameters are optional:

\begin{itemize}
    \item --testsize is size of resulting image. By default 352.
    \item --backbone change backbone used. Possible values: VGGNet16, ResNet50, \\ Res2Net50. By default Res2Net50. Only in MyTest\_LungInf.py. In MyTBin.py Res2Net50 is only option.
\end{itemize}

\subsection{Cleanup}

To make cleanup of images run Cleanup.py with following parameter:

\begin{itemize}
    \item --data\_path is path to GT images.
\end{itemize}

The new images will overwrite the old images in data\_path, so make a copy if necessary.

If you only need to Hole Filling or Elimination of additional zones, use FillHoles.py or DeleteExtraZone.py respectively with the same parameter.

\subsection{Creation of Inf-Net+Semi-inf-Net images}

Inf-Net+Semi-inf-Net is an intersection of resulting images of Inf-Net and Semi-Inf-Net. To generate this intersection, first generate Inf-Net and Semi-Inf-Net, then run Intersection.py with following parameters:

\begin{itemize}
    \item --inf\_path is path to Inf-Net resulting images
    \item --semi\_path is path to Semi-Inf-Net resulting images
    \item --save\_path is path where results will be saved. (To save in a folder named "Folder", the path must end with "Folder/", otherwise all files will be saved in the previous folder and with the image name prefixed "Folder".)
\end{itemize}

\subsection{Evaluation}

To evaluate acquired images with existing GT images of the same dataset using Dice and IOU run Dice.py with following parameters:

\begin{itemize}
    \item --data\_path is path to acquired GT images.
    \item --reference is path to existing GT images. This folder should contain a "GT" folder with GT images.
\end{itemize}

The result will be saved in file metrics.txt of data\_path folder.

To create visual mask run VisualMark.py with following parameters:

\begin{itemize}
    \item --data\_path is path to images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and optionally an "Edge" folder if edge images exist.
    \item --save\_path is path where results will be saved.
    \item --is\_edge by default False. Use True if edge images exists.
\end{itemize}
