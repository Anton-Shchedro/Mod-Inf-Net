# Usage 

This project is made in the form of several scripts, and in order to use different parts of this project, you need to run the scripts separately.

## Environment (Prerequisites)

Inf-Net use environments with CUDA-10.0. It may work with other environment, but is not guarantee.

Creating a virtual environment in terminal: conda create -n INFnet python=3.6.

Installing necessary packages: pip install -r requirements.txt.

Installing THOP for counting the FLOPs/Params of model (of necessity).

Some required packages may fail during installation, in which case the user have to find a workaround to install the missing packages.

## Training Inf-Net

Different backbones can be used to train Inf-Net, but only Res2Net was used in this project, and the correct operation of other backbones is not guaranteed.

To train Inf-Net use MyTrain_LungInf.py with the following parameters:

- --train_path is path to training dataset. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.
- --is_semi for Inf-Net has to be set to False.
- --is_pseudo for Inf-Net has to be set to False.

Following parameters are optional to change:

- --backbone change different backbone. Possible choice: VGGNet16, ResNet50, Res2Net50. By default is Res2Net50
- --epoch by default is 100. Is epoch number.
- --batchsize is training batch size. Depends of users hardware. By default is 24.
- --num_workers is number of workers in dataloader. Depends of users hardware. By default is 8
- --trainsize is set the size of training sample. This parameter specify the height and width of image in pixels. By default is 352.
- --is_thop - whether calculate FLOPs/Params (Thop). By default is False.
- --net_channel is internal channel numbers in the Inf-Net. By default is 32.
- --n_classes is number of classes to segment. Binary segmentation when 1. By default is 1
- ...
- -h for the full list of parameters


The weights will be saved in ./Snapshots/save_weights/Inf-Net/

## Training of Semi-Inf-Net

Semi-inf-Net, as was mention before, use Inf-Net as initial network for generation of pseudo labels. Is necessary to train Inf-Net before Semi-Inf-Net.

First divide the dataset of unlabeled images in groups of 5 images. It's possible to use ./Code/utils/split_1600.py to do it with following parameters:

- --data_path is path to unlabeled images.
- --save_path is path to save groups of images.

Then run PseudoGenerator.py with folowing parameters:

- --data_path is path unlabeled images (--save_path from split_1600.py).
- --label_path is path to labeled images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.

Additional parameters are optional:

- --epoch by default is 100. Is epoch number.
- --batchsize is training batch size. Depends of users hardware. By default is 24.
- --trainsize is set the size of training sample. This parameter specify the height and width of image in pixels. By default is 352.
- ...
- -h for the full list of parameters

The pseudo dataset will be in folder "Pseudo" in data_path directory.

When unlabeled images have pseudo labels, run MyTrain_LungInf.py with the following parameters:

- --train_path is path to dataset with pseudo labeled images (generated by PseudoGenerator.py)
- --is_semi set to False.
- --is_pseudo set to True.

Then run again MyTrain_LungInf.py with the following parameters:

- --train_path is path to **labeled** images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and an "Edge" folder with edge images.
- --is_semi set to True.
- --is_pseudo set to False.

The weights will be saved in ./Snapshots/save_weights/Semi-Inf-Net

## Creation of resulting images

To generate a GT image (Inf-Net or Semi-Inf-Net) from a test image without threshold, run MyTest_LungInf.py. To generate a GT image (Inf-Net or Semi-Inf-Net) from a test image with threshold, run MyTBin.py

Following parameters are in both scripts:

- --data_path is path to test dataset.  This folder should contain an "Imgs" folder with images.
- --pth_path is path to weights of network.
- --save_path is path where results will be saved. (To save in a folder named "Folder", the path must end with "Folder/", otherwise all files will be saved in the previous folder and with the image name prefixed "Folder".)

Following parameters are optional:

- --testsize is size of resulting image. By default 352.
- --backbone change backbone used. Possible values: VGGNet16, ResNet50, \\ Res2Net50. By default Res2Net50. Only in MyTest\_LungInf.py. In MyTBin.py Res2Net50 is only option.

## Cleanup

To make cleanup of images run Cleanup.py with following parameter:

- --data\_path is path to GT images.

The new images will overwrite the old images in data\_path, so make a copy if necessary.

If you only need to Hole Filling or Elimination of additional zones, use FillHoles.py or DeleteExtraZone.py respectively with the same parameter.

## Creation of Inf-Net+Semi-inf-Net images

Inf-Net+Semi-inf-Net is an intersection of resulting images of Inf-Net and Semi-Inf-Net. To generate this intersection, first generate Inf-Net and Semi-Inf-Net, then run Intersection.py with following parameters:

- --inf_path is path to Inf-Net resulting images
- --semi_path is path to Semi-Inf-Net resulting images
- --save_path is path where results will be saved. (To save in a folder named "Folder", the path must end with "Folder/", otherwise all files will be saved in the previous folder and with the image name prefixed "Folder".)

## Evaluation

To evaluate acquired images with existing GT images of the same dataset using Dice and IOU run Dice.py with following parameters:

- --data_path is path to acquired GT images.
- --reference is path to existing GT images. This folder should contain a "GT" folder with GT images.

The result will be saved in file metrics.txt of data_path folder.

To create visual mask run VisualMark.py with following parameters:

- --data_path is path to images. This folder should contain an "Imgs" folder with images, a "GT" folder with GT images, and optionally an "Edge" folder if edge images exist.
- --save_path is path where results will be saved.
- --is_edge by default False. Use True if edge images exists.
